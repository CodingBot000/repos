# TimeTableWork


- Library : 
Koin injection,
MVVM,
Retrofit, RxJava,
LiveData, 
Room DataBase

- Data Layer :
Repository,
DataSource

- DI :
Koin



[기본동작]
처음시작 -> 로컬DB를 뒤져서 가져와서 시간표에 표기.
강의등록 /취소 -> 등록,취소 동작을하면 해당 화면이 자동으로 닫히면서 시간표화면으로 돌아가서 갱신
메모등록/삭제 -> 메모등록은 첫 화면으로 돌아감. 삭제는 리스트에서 삭제버튼을 눌러서 하는것이므로 돌아가지않고 그자리에서 삭제. 삭제하면 리스트는 순서를 재정렬.

재시작 -> 앞의 동작에서 로컬DB에 저장한것이 있다면 시간표에 표기.

달력 -> 오늘 날짜에 대해서만 시간표 등록 가능


기본적으로 api요청 (등록/삭제) -> 정상인경우면 -> 로컬DB 등록/삭제

만약 정보가 불일치하다면 (강의가 로컬에는 있는데 원격에는 없음)
이미 삭제된 데이터란 정보를 주기때문에 에러가 나도 로컬의 데이터를 삭제

UI보다는 기능위주로. UI는 다소 무시 

* 동기화 처리

요건에는 없지만 강의를 시간표에 등록한 상태에서 앱을 삭제후 재 설치시 로컬에 데이터가 없어서 시간표는 비어있지만 삭제전 등록한 강의를 추가하려고하면 이미 등록된 강의라고 나오면서 영원히 추가를 못하게됨.
이에 상단에 Sync라는 동기화버튼을 만들어서 누르면
1. 기존로컬DB삭제
2. 서버에 등록한 데이터요청(강의코드만 옴, 메모는 제목, 타입 등 입력한정보 다옴)
3. 받은 강의코드 리스트로 전체강의 리스트와 비교해서 강사, 강의실 , 시간 등 해당강의 코드의 모든 강의정보 가져와서
4. 다시 로컬DB에 넣어서 서버의 내용과 동기화


[오픈소스 활용]
https://github.com/tlaabs/TimetableView

커스터마이징이 많이 필요해서 소스파일을 package timetableview 에 소스를 넣어서 사용.
처음에 그리드로 할까 생각했으나 cell을 span해야하고 5분단위로 쪼개서 그리드셀을 만들어 span한다 쳐도
모두 높낮이가 별개로 나타날 것이기 때문에 제어가 녹록치않을것 이라 판단.
StaggeredLayout도 생각해봤는데 정확한 cell 높이 재는데 적합하지않다 판단.
그래서 효율적으로 진행하기 위해 오픈소스 활용
오픈소스가 활용하기에 맞지않아 커스터마이징 진행



[시간표 리프레쉬 처리] - RxEventBus
변경 이벤트가 발생하였을때 (강의등록/취소, 매모 등록/삭제 등)만 리프레쉬를 처리하기위해 이벤트를 보내서 메인에서 이벤트 수신시만 리로드.
이벤트는 어디서나 쉽게 보내고 받을수있어야 해서 옛날에는 브로드캐스트리시버를 썼지만 좀더 심플한 RxEventBus를 활용

[메모 API 오류]
메모를 등록할때 메모타입도 설정해야하며 특히 메모타입과 강의코드 등 몇가지 조합이 유니크키로 동작하여 같으면 추가 메모 등록이 안됨. 
즉, 동일한 타입으로 등록하면 동록안됨. (서버에서 거부)

[로컬DB용 유니크키 설정]
수강한 강의 정보 테이블과 메모 테이블에 대해서 둘간에 join이 가능해야하는데, 강의 코드가 중복된 두개이상 요일의 강의의 경우 별도의 메모등록을 하도록 구현하기 위해서
로컬에서만 쓰는 유니크한 키의 필요성.
강의코드_요일번호 (요일번호는 월부터 일까지 0,1,2,3... 이렇게 구성)


[강의 취소 안되는 케이스]
하나의 강의코드가 두개의 요일을 가진경우 해당 강의를 등록하면 두개의 요일에 동시에 등록되도록 했음.
그런데 이중 하나를 강의 취소하고 나머지 하나를 마저 취소하려고 하면 아래처럼 에러가 발생
정확히 뭐가 문제인지 서버에서 알려주지 않음 
{"message":"강의 코드 삭제 에러 : ConditionalCheckFailedException: The conditional request failed"}%    
아마도 강의 취소시 전달하는 값이 user_key와 과목코드인데 당연히 두 요일을 가진 두 과목을 취소요청하는 request는 동일할 것이고
그러면 하나를 취소후에 동일한 코드가있다면 마저 자동으로 로컬데이터를 삭제해야하는 것으로 추정함  (메모를 두개의 강의별 따로 저장하게 구현했기때문에 그렇게 생각하지않았음)
일단 하나를 취소하고 다른 하나를 취소하게 되는 경우 422 에러가 나는데 이 경우 로컬것을 삭제해버리는 예외처리 구현


